version: "3.8"
# -----------------------------
# DISCLAIMER : this file is for local dev. Cannot solve all local dev needs so it might be needed to slightly modify it, if current setup doesn't support desired scenario/setup. 
# Nominal case for this file is that this docker-compose-dev-local-db.yml is triggered via 
# ./scripts/dev_local.sh, use "./scripts/dev_deploy.sh -h" for help how to use this script
# It is a wrapper script adding some additional parameters for building the docker images, e.g. file for local db restoration from a backup file, etc.
# -----------------------------
# !!! Check that secrets at bottom of this compose file are mapped to EXISTING secrets file if not, update path accrodingly !!!! Doesn't need to be in default location as mentioned below.
#-------------------------------------------
services:
  web:
    build:
      context: .
      dockerfile: Dockerfile-DEV
    # > sleep at the beginning is due to waiting for DB restore that tooks time, if server is started earlier than DB restore is done then web service must be restarted manually to work correctly
    # !!!Please EACH DEV update sleep CONSTANT according to your needs, default time is safe constant 
    # repsecting that restoration of db from file can take some time and web container needs to start 
    # after db is fully restored. Otherwise this container needs to be restarted manually (just this container)
    # if DB is not going to be restored during docker-compose up/start then this sleep constant can be removed completely
    command: sh -c "sleep 100 && /scripts/entrypoint.dev.sh"
    #  [
    #    "sh",
    #    "-c",
    #    "pip install debugpy -t /tmp && python3 /tmp/debugpy --wait-for-client --listen 0.0.0.0:5678 manage.py runserver 0.0.0.0:8000",
    #  ]
    secrets:
      - db_conf
      - mail_conf
    restart: on-failure
    volumes:
      - ./webclient:/code
      - ./vol/web:/vol/web
      - locale_data:/vol/web/locale
    ports:
      - "8000:8000"
      - "5678:5678"
    environment:
      - DJANGO_SETTINGS_MODULE=webclient.settings.dev
    depends_on:
      - db  
  
  livereload:
    build:
      context: .
      dockerfile: Dockerfile-DEV
    # > sleep at the beginning is due to waiting for DB restore that tooks time, if server is started earlier than DB restore is done then livereload service must be restarted manually to work correctly
    # !!!Please EACH DEV update sleep CONSTANT according to your needs, default time is safe constant 
    # repsecting that restoration of db from file can take some time and web container needs to start 
    # after db is fully restored. Otherwise this container needs to be restarted manually (just this container)
    # if DB is not going to be restored during docker-compose up/start then this sleep constant can be removed completely
    command: sh -c "sleep 120 && python3 manage.py livereload --host=0.0.0.0 --port=35729"
    volumes:
      - ./webclient:/code
    restart: on-failure
    secrets:
      - db_conf
      - mail_conf
    ports:
      - "35729:35729"
    environment:
      - DJANGO_SETTINGS_MODULE=webclient.settings.dev
    depends_on:
      - web
      - db
  db:
    build:
      context: .
      dockerfile: Dockerfile-DB
    ports:
      - "5432:5432"
    secrets:
     - local_db_pass
    environment:
      - DBNAME=aiscrrestore
      - POSTGRES_PASSWORD_FILE=/run/secrets/local_db_pass
    
  pgadmin:
    image: dpage/pgadmin4
    secrets:
      - pg_admin_pass
    ports:
     - 88:80
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@admin.net
      - PGADMIN_DEFAULT_PASSWORD_FILE=/run/secrets/pg_admin_pass
    volumes:
      - pg_admin_vol:/var/lib/pgadmin/
    depends_on:
      - db

  memcached:
    image: memcached:latest
    ports:
      - "11211:11211"

volumes:
  locale_data:
  pg_admin_vol:

secrets:
  pg_admin_pass:
    # PLEASE CHECK and UPDATE path accordingly to a secret setting pg_admin web client password )
   file: ./secrets/pg_admin_pass
  local_db_pass:
    # PLEASE CHECK and UPDATE path accordingly to a secret setting DB password for local database, needs to match with db_conf secret if local db is used)
    file : ./secrets/local_db_pass
  db_conf:
    # PLEASE CHECK and UPDATE path accordingly to a file containing configuration for web container specifying DB connection (doesn't need to be repo root)
     file: ./secrets.alternative.json
  mail_conf:
  # PLEASE CHECK and UPDATE path accordingly to a file containing configuration for web container specifying mailtrap setting (doesn't need to be repo root)
     file: ./secrets_mail_client.json
