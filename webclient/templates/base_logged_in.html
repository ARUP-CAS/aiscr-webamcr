{% extends "base.html" %}
{% load i18n %}
{% load compress %}
{% load static %}
{% load l10n %}
{% load template_tags%}

{% block sidebar %}
  <!-- {% compress css %}
    <link type="text/x-scss" href="{% static '_app-sidebar.scss' %}" rel="stylesheet" media="screen">
  {% endcompress %} -->
  <div id="app-sidebar-wrapper">
    <div class="app-sidebar-heading">
      <a href="/" title="{% trans 'Domů' %}">
        <img src="{% static 'logo-am-cs.png' %}" alt="{% trans 'Archeologická mapa České republiky' %}" />
      </a>
    </div>
    <div class="accordion" id="accordionSidebar">
      <div class="card">
        <div class="card-header">
          <h2 class="mb-0">
            <button class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse"
                    data-target="#collapseProjekty" aria-expanded="false" aria-controls="collapseProjekty">
              <span class="material-icons">dynamic_feed</span> {% trans "Projekty" %}
              <span class="material-icons app-icon-expand">expand_more</span>
            </button>
          </h2>
        </div>
        <div id="collapseProjekty" class="collapse" data-parent="#accordionSidebar">
          <div class="card-body">
            <ul>
              <li><a href="{% url 'projekt:index' %}">{% trans "Domů" %}</a></li>
              <li><a href="{% url 'projekt:create' %}">{% trans "Zapsat" %}</a></li>
              <li><a href="{% url 'projekt:list' %}?stav={{PROJEKT_STAV_OZNAMENY}}">{% trans "Schválit oznámení" %}</a></li>
              <li><a href="{% url 'projekt:list' %}?stav={{PROJEKT_STAV_ZAPSANY}}">{% trans "Přihlásit projekt" %}</a></li>
              <li><a href="{% url 'projekt:list' %}?stav={{PROJEKT_STAV_PRIHLASENY}}&organizace={{ user.organizace.id }}">{% trans "Zahájit výzkum" %}</a></li>
              <li><a href="{% url 'projekt:list' %}?stav={{PROJEKT_STAV_ZAHAJENY_V_TERENU}}&organizace={{ user.organizace.id }}">{% trans "Ukončit terén" %}</a></li>
              <li><a href="{% url 'projekt:list' %}?stav={{PROJEKT_STAV_ZAHAJENY_V_TERENU}}&stav={{PROJEKT_STAV_UKONCENY_V_TERENU}}&organizace={{ user.organizace.id }}">{% trans "Spravovat akce" %}</a></li>
              <li><a href="{% url 'projekt:list' %}?stav={{PROJEKT_STAV_UKONCENY_V_TERENU}}&organizace={{ user.organizace.id }}">{% trans "Uzavřít projekt" %}</a></li>
              <li><a href="{% url 'projekt:list' %}">{% trans "Vybrat projekty" %}</a></li>
              <li><a href="{% url 'projekt:list' %}?organizace={{user.organizace.id}}">{% trans "Naše projekty" %}</a></li>
              <li><a href="{% url 'projekt:list' %}?stav={{PROJEKT_STAV_UZAVRENY}}">{% trans "Archivovat projekty" %}</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2 class="mb-0">
            <button class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse"
                    data-target="#collapse3d" aria-expanded="true" aria-controls="collapse3d">
              <span class="material-icons">3d_rotation</span> {% trans "Knihovna 3D" %}
              <span class="material-icons app-icon-expand">expand_more</span>
            </button>
          </h2>
        </div>
        <div id="collapse3d" class="collapse" data-parent="#accordionSidebar">
          <div class="card-body">
            <ul>
              <li><a href="{% url 'dokument:index-model-3D' %}" title="">{% trans "Domů" %}</a></li>
              <li><a href="{% url 'dokument:create-model-3D' %}" title="">{% trans "Zapsat" %}</a></li>
              <li><a href="{% url 'dokument:list-model-3D' %}?vlastnik={{ user.id }}" title="">{% trans "Moje modely" %}</a></li>
              <li><a href="{% url 'dokument:list-model-3D' %}" title="">{% trans "Vybrat" %}</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2 class="mb-0">
            <button class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse"
                    data-target="#collapseSn" aria-expanded="false" aria-controls="collapseSn">
              <span class="material-icons">location_on</span> {% trans "Samostatné nálezy" %}
              <span class="material-icons app-icon-expand">expand_more</span>
            </button>
          </h2>
        </div>
        <div id="collapseSn" class="collapse" data-parent="#accordionSidebar">
          <div class="card-body">
            <ul>
              <li><a href="{% url 'pas:index' %}" title="">{% trans "Domů" %}</a></li>
              <li><a href="{% url 'pas:create' %}" title="">{% trans "Zapsat" %}</a></li>
              <li><a href="{% url 'pas:list' %}?vlastnik={{ user.id }}" title="">{% trans "Moje nálezy" %}</a></li>
              <li><a href="{% url 'pas:list' %}" title="">{% trans "Vybrat" %}</a></li>
              <li><a href="{% url 'pas:spoluprace_list' %}" title="">{% trans "Spolupráce" %}</a></li>
              <li><a href="{% url 'pas:list' %}?stav=2&predano_organizace={{ user.organizace.id }}" title="">{% trans "Potvrdit" %}</a></li>
              <li><a href="{% url 'pas:list' %}?stav=3" title="">{% trans "Archivovat" %}</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2 class="mb-0">
            <button class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse"
                    data-target="#collapseAdmin" aria-expanded="false" aria-controls="collapseAdmin">
              <span class="material-icons">settings</span> {% trans "Administrace" %}
              <span class="material-icons app-icon-expand">expand_more</span>
            </button>
          </h2>
        </div>
        <div id="collapseAdmin" class="collapse" data-parent="#accordionSidebar">
          <div class="card-body">
            <ul>
              <li><a href="/admin/uzivatel/user/" title="">{% trans "Uživatelé" %}</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block navbar %}
  <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
    <button class="btn btn-light mb-0 mt-0" id="sidebar-toggle"><span class="material-icons">menu_open</span></button>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMobile"
            aria-controls="navbarMobile" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMobile">
      <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
        <li class="nav-item d-lg-none d-xl-block">
          <span class="nav-link">
            <small>
              <strong>{% trans "Přihlášen" %}:</strong> {{ user.email }} ({{ user.hlavni_role }} - {{ user.organizace }})
            </small>
          </span>
        </li>
        <li class="nav-item app-pipe"></li>
        <li class="nav-item d-lg-none d-xl-block">
          <span class="nav-link">
            <small>
              <strong>{% trans "nav.autologout.text" %}:</strong> <span id="time">01:00</span>
            </small>
          </span>
        </li>
        <li class="nav-item d-none d-lg-block d-xl-none">
          <a href="#" class="nav-link" tabindex="0" data-trigger="focus" data-toggle="popover" data-placement="bottom"
            data-content="<strong>{% trans 'Přihlášen' %}:</strong> {{ user.email }} ({{ user.hlavni_role }} - {{ user.organizace }})">
            <span class="material-icons">info</span>
            {% trans "Informace" %}
          </a>
        </li>
        <li class="nav-item app-pipe"></li>
        <li class="nav-item">
          <a class="nav-link" href="#" rel="tooltip" data-placement="top" title="{% trans 'Informace o uživateli' %}">
            <span class="material-icons">person</span>
            <span>{% trans "Uživatel" %}</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'logout' %}" rel="tooltip" data-placement="top" title="{% trans 'Odhlásit' %}">
            <span class="material-icons">logout</span>
            {% trans "Odhlásit" %}
          </a>
        </li>
        <li class="nav-item app-pipe"></li>
        <li class="nav-item app-flags">
          <a class="nav-link app-active" href="#">
            <img src="{% static 'flag-cs.svg' %}" alt="" class="app-flag" />
          </a>
          <a class="nav-link" href="#">
            <img src="{% static 'flag-en.svg' %}" alt="" class="app-flag" />
          </a>
        </li>
      </ul>
    </div>
  </nav>
{% endblock %}

{% block modal-form %}
  <div class="modal fade app-modal-form" tabindex="-1" role="dialog" id="modal-form">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
      <div class="modal-content form" id="id-modal-content"></div>
    </div>
  </div>
{% endblock %}

{% block footer %}
  <footer class="text-lg-start">
    <div class="d-flex justify-content-between p-3 app-footer-wrapper">
      <div>
        <a href="#" class="text-uppercase" data-toggle="modal" data-target="#footerLicence">{% trans "Licence" %}</a><span class="app-pipe"></span><!--
        --><a href="#" class="text-uppercase" data-toggle="modal" data-target="#footerKontakt">{% trans "Kontakt" %}</a><span class="app-pipe"></span><!--
        --><a href="#" class="text-uppercase" data-toggle="modal" data-target="#footerPartneri">{% trans "Partneři" %}</a>
      </div>
      <div>
        <small>
          © 2021 Copyright
          <a class="text-dark" href="https://mdbootstrap.com/">AMČR</a><span class="app-pipe"></span>Verze: 1.0.0
        </small>
      </div>
    </div>
  </footer>

  {% include "footer_licence.html" %}
  {% include "footer_kontakt.html" %}
  {% include "footer_partneri.html" %}
{% endblock %}

{% block script_sidebar %}
  <script>
    $("#sidebar-toggle").click(function (e) {
      e.preventDefault();
      $("#app-wrapper").toggleClass("toggled");
    });
    $('[rel="tooltip"]').tooltip({
      container : '#app-page-wrapper',
      html : true,
    });
    $('[data-toggle="popover"]').popover({
      html : true
    });
  </script>

  <script>
      // Open sidebar based on the url i am viewing
      $(document).ready(function () {
          if (window.location.href.indexOf("projekt") > -1) {
              $('#collapseProjekty').collapse('show')
          } else if (window.location.href.indexOf("model") > -1) {
              $('#collapse3d').collapse('show')
          } else if (window.location.href.indexOf("pas") > -1) {
              $('#collapseSn').collapse('show')
          }
      });
      const goBack = () => {
          window.history.back();
      }

</script>
<script src="{% static '/js/create_message.js' %}"></script>
<script>
  // for autologout functionality timer and messages
    var time = {% if seconds_until_idle_end %} {{ seconds_until_idle_end|unlocalize }} {% else %} 60 * 60 {% endif %};
    var timer = new Timer();
    var interval = null;
    let document_title = document.title;

    document.head = document.head || document.getElementsByTagName('head')[0];

    var fav_not = "{%  static '/loga/favicon-dot.png' %}"
    var fav = "{%  static '/loga/favicon.png' %}"
    function changeFavicon(src) {
      var link = document.createElement('link'),
      oldLink = document.getElementById('dynamic-favicon');
      link.id = 'dynamic-favicon';
      link.rel = 'shortcut icon';
      link.href = src;
      if (oldLink) {
        document.head.removeChild(oldLink);
      }
      document.head.appendChild(link);
    }
    function startNotify(src) {
      changeFavicon(src)
      let period_count = 1;
      interval = setInterval(function() {
        if ((period_count % 2 )== 1){
          document.title = '\u200E';
        }
        else {
          document.title = document_title; 
        }
        period_count = period_count + 1
      }, 1000); 
      notifyShown = true
    }
    function stopNotify(src){
      changeFavicon(src);
      clearInterval(interval);
      document.title = document_title;
      notifyShown = false
    }
    var notifyShown = false
    
    timer.start({countdown: true, startValues: {seconds: time}});
    $('#time').html(timer.getTimeValues().toString(['minutes', 'seconds']));
    
    timer.addEventListener('secondsUpdated', function (e) {
      var actual_time = timer.getTimeValues().toString(['minutes', 'seconds']).padStart(5,"0")
      $('#time').html(actual_time);
      var idle_warning = {% if IDLE_WARNING_TIME %} '{{IDLE_WARNING_TIME}}' {%else%} false {% endif%};
      if (idle_warning !== false) {
        if (actual_time <= idle_warning.padStart(5,"0") && notifyShown === false) { 
          startNotify(fav_not)                
          createMessage("warning",({% get_message "AUTOLOGOUT_EXPIRATION_WARNING" %}), 'True','True','False')
        };
      };
    });

    timer.addEventListener('targetAchieved', function (e) {
      {{redirect_to_login_immediately}}
    });
    $('.message-container').on('click', '#prolong_btn', function () {
      $.ajax({
        type: "GET",
        url: '{% url "core:prolong_session" %}',
        dataType: 'json',
        success: function(data){
          console.log("session prolonged"+data.session_time)
          $(".app-alert-floating").alert('close');
          timer.stop();
          timer.start({countdown: true, startValues: {seconds: data.session_time}});
          $('#time').html(timer.getTimeValues().toString(['minutes', 'seconds']));
          createMessage("success",({% get_message "AUTOLOGOUT_REFRESH_SUCCESS" %}));
          stopNotify(fav) 
        },
          
        error: ()=>{
          $(".app-alert-floating").alert('close');
          createMessage("danger",({% get_message "AUTOLOGOUT_REFRESH_ERROR" %}))
          stopNotify(fav)
        }
      })
    });

    const increase_ul_height = (parent_element) => {
        const li_elements = parent_element.querySelectorAll("li.select2-selection__choice");
        const select2_element = parent_element;
        const select2_element_selection_rendered = parent_element.querySelector(".select2-selection__rendered")
        const select2_element_selection = parent_element.querySelector(".select2-selection");
        let element_line_width_sum = 0;
        const line_limits = [parent_element.offsetWidth - 5 - 16, parent_element.offsetWidth - 5, parent_element.offsetWidth - 5];
        let current_line = 1;
        for (const li_element of li_elements) {
            // Added borders, padding and margins
            element_line_width_sum += li_element.offsetWidth + 5 + 5 + 1 + 1 + 5;
            if (element_line_width_sum > line_limits[current_line-1]) {
                current_line++;
                element_line_width_sum = 0;
            }
        }
        const rows_needed = Math.min(current_line, 3);
        const height = 1.5 * Math.min(Math.max(rows_needed, 1), 3);
        if (select2_element) {
            select2_element.style = `height: ${height}rem!important;`;
        }
        if (select2_element_selection) {
            select2_element_selection.style = `height: ${height}rem!important;`;
        }
        if (select2_element_selection_rendered) {
            select2_element_selection_rendered.style = `height: ${height}rem!important;`;
        }
    }

    setTimeout(() => {
        const span_selection_rendered_query = document.body.querySelectorAll("span.select2.select2-container");
        span_selection_rendered_query.forEach(item => {
            item.addEventListener("mouseover", () => {
                increase_ul_height(item);
            });
            item.addEventListener("keydown", () => {
                increase_ul_height(item);
            });
        })
    }, 5000);


</script>
{% endblock %}