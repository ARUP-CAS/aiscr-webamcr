{% load i18n %}
{% load static %}
{% load crispy_forms_tags %}
{% load template_filters %}

<div class="card app-card-form" id="detail_pian_form_{{ pian_ident_cely }}">
  <div class="card-header">
    <div class="app-fx app-left">
      {% trans "arch_z.templates.arch_z.dj.partials.pian_update.cardHeader.label" %}  {{ pian_ident_cely }}
    </div>
  </div>
  <div class="card-body">
    <form class="mb-3" method="POST" action="{% url 'pian:detail' pian_ident_cely %}"
          onsubmit="editPianButton.disabled = true; return true;">
      {% crispy pian_form_update %}
      {% if show.editovat %}
        <input type="hidden" name="dj_ident_cely" value="{{ dj_ident_cely }}">
        <button type="submit" id="editPianButton"
                class="btn btn-primary">{% trans "arch_z.templates.arch_z.dj.partials.pian_update.editButtons.upravitPian.label" %}</button>
      {% endif %}
    </form>
  </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById("djMap").scrollIntoView();
      let xhr = new XMLHttpRequest();
              xhr.open('POST', '/arch-z/mapa-zoom');
              xhr.setRequestHeader('Content-type', 'application/json');
              if (typeof global_csrftoken !== 'undefined') {
                  xhr.setRequestHeader('X-CSRFToken', global_csrftoken);
              } else {
                  console.log("neni X-CSRFToken token")
              }
              xhr.onload = function () {                  
                  const rs = JSON.parse(this.responseText);
                  if (rs.count==0 ){
                      switchMap(false);
                      return;
                  }
                  zoom_pian=rs.pians.find((element) => element.color=='gold' )
                  if(zoom_pian==undefined)zoom_pian= rs.pians[0];
                  if(zoom_pian.zoom==12){
                          if(zoom_pian.bbox!=""){
                              box=[]
                              zoom_pian.bbox.split("((")[1].split(")")[0].split(",").forEach(i => {                          
                                  box.push([i.split(" ")[1].trim(), i.split(" ")[0].trim()]);
                              })
                              //latLng(40.712, -74.227),
                              map.fitBounds([ [box[0][0],box[0][1] ],[box[2][0],box[2][1] ]]);
                          }
                          else map.setView([zoom_pian.lat, zoom_pian.lng], zoom_pian.zoom)
                  }
                  else{
                      map.setView([zoom_pian.lat, zoom_pian.lng], zoom_pian.zoom)
                      poi_dj.clearLayers(); 
                      drawnItems.clearLayers();
          
                      rs.pians.forEach((pian) => {
                        if(!checkBlockedByQWuery() && !global_blocked_by_query_geom && pian.color =='gold'  ){                                       
                            addDJPian([pian.lat, pian.lng],  drawnItems,pian.pian_ident_cely,pian.geom,pian.presnost,pian.color);
                        }  
                       else  addDJPian([pian.lat, pian.lng],  poi_dj,pian.pian_ident_cely,pian.geom,pian.presnost,pian.color);                   
                        
                        
                      })
                      geomToText();
                      save_edited_geometry_session();
                  }

              };
              xhr.send(JSON.stringify(
                  {
                      'cadastre': document.getElementById("main_cadastre_id").value,
                      'akce_ident_cely': '{{ dj_ident_cely }}',
                  }))
               /*   arch_select_perspective(
                    currentUrl,
                    document.getElementById("main_cadastre_id").value,
                    '{{ zaznam.ident_cely }}',
                    currentUrl.substr(currentUrl.lastIndexOf("-D"))
                    )*/
        //show_form(`detail_pian_form_{{ pian_ident_cely}}`);
        map_show_edit(true);
        global_map_projekt_ident='{{ dj_ident_cely }}';
       // switchMap(true,'{{ pian_ident_cely}}')
    });
</script>
