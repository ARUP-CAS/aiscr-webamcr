{% extends "base_logged_in.html" %}
{% load i18n %}
{% load static %}
{% load crispy_forms_tags %}
{% load template_filters %}

{% block title %}{% trans "Detail archeologického záznamu - akce" %}{% endblock %}
{% block head %}
  <!--  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">-->

  <!-- Leaflet imports -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
          integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
          crossorigin="">
  </script>
  <!--contextmenu-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-contextmenu/1.4.0/leaflet.contextmenu.min.js" integrity="sha512-8sfQf8cr0KjCeN32YPfjvLU2cMvyY1lhCXTMfpTZ16CvwIzeVQtwtKlxeSqFs/TpXjKhp1Dcv77LQmn1VFaOZg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-contextmenu/1.4.0/leaflet.contextmenu.min.css" integrity="sha512-AiWBM2PiPZkogKBj8Jss3MahJ+bRbSMebXUBwZMg+83vJTnZT/FXoxZrmpL+x9GbAYLWRuBZDqzhDt0Dk73qhw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!--Leaflet Buttons-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
  <!--Leaflet Draw-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">

  <!--Leaflet FullScreen-->
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
  <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css'
        rel='stylesheet'/>

  <!--Mark Cluster-->


  <link rel="stylesheet" type="text/css" href="{% static 'bs-stepper.min.css' %}"/>

  <!-- Autocomplete media files -->
  <link href="/static/static/admin/css/vendor/select2/select2.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/static/static/admin/css/autocomplete.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/static/static/autocomplete_light/select2.css" media="screen" rel="stylesheet" type="text/css">
  <script src="/static/static/admin/js/vendor/select2/select2.full.js"></script>
  <script src="/static/static/autocomplete_light/autocomplete_light.js"></script>
  <script src="/static/static/autocomplete_light/select2.js"></script>
  <script src="/static/static/autocomplete_light/i18n/cs.js"></script>


  <script src="{% static 'convertToJTSK.js' %}"></script>
  <script src="{% static 'simpleheat.js' %}"></script>
  <script src="{% static 'HeatLayer.js' %}"></script>
  <script src="{% static 'leaflet.markercluster-src.js' %}"></script>
  <link rel="stylesheet" href="{% static 'MarkerCluster.css' %}" />
  <link rel="stylesheet" href="{% static 'MarkerCluster.Default.css' %}" />


  <script>
      var global_csrftoken = '{{ csrf_token }}';
  </script>
  <!-- static leaflet additional import-->
  <link rel="stylesheet" href="{% static 'leaflet.measure.css' %}"/>
  <script src="{% static 'leaflet.measure.js' %}"></script>
  <script type="text/javascript" src="{% static 'leaflet.coor.js' %}"></script>
  <link rel="stylesheet" href="{% static 'leaflet.coor.css' %}"/>
{% endblock %}

{% block content %}
  <div class="app-entity-akce">
    {% include "toolbar_akce.html" with zaznam=zaznam  showbackdetail=True showcontrols=True %}

    <!-- stepper -->
    <div class="bs-stepper">
      <div class="bs-stepper-header">
        <div class="step {% if zaznam.stav == 1 %}active{% endif %}">
          <button type="button" class="btn step-trigger historie-link" onclick="location.href='{% url 'historie:akce' zaznam.ident_cely %}';">
            <span class="bs-stepper-circle">1</span>
            <span class="bs-stepper-label">
            {% trans "Rozepsaná" %}
            <span class="app-stepper-date" rel="tooltip" data-placement="bottom"
                  title="{{ history_dates.datum_zapsani.uzivatel }}">
              {{ history_dates.datum_zapsani.datum|date:'Y-m-d'|default_if_none:"" }}
            </span>
          </span>
          </button>
        </div>
        <div class="line"></div>
        <div class="step {% if zaznam.stav == 2 %}active{% endif %}">
          <button type="button" class="btn step-trigger historie-link" onclick="location.href='{% url 'historie:akce' zaznam.ident_cely %}';">
            <span class="bs-stepper-circle">2</span>
            <span class="bs-stepper-label">
            {% trans "Odeslaná" %}
            <span class="app-stepper-date" rel="tooltip" data-placement="bottom"
                  title="{{ history_dates.datum_odeslani.uzivatel }}">
              {{ history_dates.datum_odeslani.datum|date:'Y-m-d'|default_if_none:"" }}
            </span>
          </span>
          </button>
        </div>
        <div class="line"></div>
        <div class="step {% if zaznam.stav == 3 %}active{% endif %}">
          <button type="button" class="btn step-trigger historie-link" onclick="location.href='{% url 'historie:akce' zaznam.ident_cely %}';">
            <span class="bs-stepper-circle">3</span>
            <span class="bs-stepper-label">
            {% trans "Archivovaná" %}
            <span class="app-stepper-date" rel="tooltip" data-placement="bottom"
                    title="{{ history_dates.datum_archivace.uzivatel }}">
                  {{ history_dates.datum_archivace.datum|date:'Y-m-d'|default_if_none:"" }}
            </span>
          </span>
          </button>
        </div>
      </div>
    </div>

    <!-- detail -->
    <div class="card app-card-form">
      <div class="card-header">
        <div class="app-fx app-left">
          {% trans "Detail" %}
        </div>
        {% if show.editovat %}
        <div class="app-fx app-right">
          <div class="btn-group" role="group">
            <a class="btn" href="{% url 'arch_z:edit' zaznam.ident_cely %}" rel="tooltip"
               data-placement="top" title="{% trans 'Upravit' %}">
              <span class="material-icons">edit</span>
            </a>
          </div>
        </div>
        {% endif %}
      </div>
      <div class="card-body">
        {% if warnings %}
        <div class="alert alert-info" role="alert">
          <ul>
            {% for warning in warnings %}
              <li>{{ warning }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
        <div class="row">
          <div class="col-sm-2">
            <div class="form-group">
              <label>{% trans "Hlavní katastr" %}</label>
              <input id="main_cadastre_id" class="form-control" type="text" value="{{ zaznam.hlavni_katastr|check_if_none }}"
                     readonly>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="form-group">
              <label>{% trans "Další katastry" %}</label>
              <input class="form-control" type="text" value="{{ zaznam.katastry.all|katastry_to_list|check_if_none }}" readonly>
            </div>
          </div>
          <div class="col-sm-2">
            <div class="form-group">
              <label>{% trans "Hlavní vedoucí" %}</label>
              <input class="form-control" type="text" value="{{ zaznam.akce.hlavni_vedouci|check_if_none }}" readonly>
            </div>
          </div>
          <div class="col-sm-2">
            <div class="form-group">
              <label>{% trans "Organizace" %}</label>
              <input class="form-control" type="text" placeholder="{{ zaznam.akce.organizace|check_if_none }}" readonly>
            </div>
          </div>
          <div class="col-sm-2">
            <div class="form-group">
              <label>{% trans "Uživatelské označení" %}</label>
              <textarea class="textarea form-control" cols="40" rows="2" placeholder="{{ zaznam.uzivatelske_oznaceni|check_if_none }}"
                        readonly>{{ zaznam.uzivatelske_oznaceni|check_if_none }}</textarea>
            </div>
          </div>
          <div class="col-sm-2">
            <div class="form-group">
              <label>{% trans "Hlavní typ" %}</label>
              <input class="form-control" type="text" value="{{ zaznam.akce.hlavni_typ|check_if_none }}" readonly>
            </div>
          </div>
          <div class="col-sm-2">
            <div class="form-group">
              <label>{% trans "Vedlejší typ" %}</label>
              <input class="form-control" type="text" value="{{ zaznam.akce.vedlejsi_typ|check_if_none }}" readonly>
            </div>
          </div>
          <div class="form-group col-sm-2">
          </div>
          <div class="col-sm-2">
            <div class="form-group">
              <label>{% trans "Specifikace data" %}</label>
              <input class="form-control" type="text" placeholder="{{ zaznam.akce.specifikace_data|check_if_none }}" readonly>
            </div>
          </div>
          <div class="col-sm-2">
            <div class="form-group">
              <label>{% trans "Datum zahájení" %}</label>
              <input class="form-control" type="text" value="{{ zaznam.akce.datum_zahajeni|date:'d.m.Y'|check_if_none }}"
                     readonly>
            </div>
          </div>
          <div class="col-sm-2">
            <div class="form-group">
              <label>{% trans "Datum ukončení" %}</label>
              <input class="form-control" type="text" value="{{ zaznam.akce.datum_ukonceni|date:'d.m.Y'|check_if_none }}"
                     readonly>
            </div>
          </div>
          <div class="col-sm-12">
            <div class="form-group">
              <label>{% trans "Lokalizace/okolnosti" %}</label>
              <textarea class="textarea form-control" cols="40" rows="1"
                        placeholder="{{ zaznam.akce.lokalizace_okolnosti|check_if_none }}" readonly>{{ zaznam.akce.lokalizace_okolnosti|check_if_none }}</textarea>
            </div>
          </div>
          <div class="col-sm-12">
            <div class="form-group">
              <label>{% trans "Poznámka" %}</label>
              <textarea class="textarea form-control" cols="40" rows="4" placeholder="{{ zaznam.akce.souhrn_upresneni|check_if_none }}"
                        readonly>{{ zaznam.akce.ulozeni_nalezu|check_if_none }}</textarea>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="form-group">
              <label>{% trans "Uložení nálezu" %}</label>
              <textarea class="textarea form-control" cols="40" rows="1" placeholder="{{ zaznam.akce.ulozeni_nalezu|check_if_none }}"
                        readonly>{{ zaznam.akce.ulozeni_nalezu|check_if_none }}</textarea>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="form-group">
              <label>{% trans "Uložení dokumentace" %}</label>
              <textarea class="textarea form-control" cols="40" rows="1" placeholder="{{ zaznam.akce.ulozeni_dokumentace|check_if_none }}"
                        readonly>{{ zaznam.akce.ulozeni_dokumentace|check_if_none }}</textarea>
            </div>
          </div>
          <div class="col-sm-2">
            <div class="form-group">
              <label>{% trans "Přístupnost" %}</label>
              <input class="form-control" type="text" value="{{ zaznam.pristupnost|check_if_none }}" readonly>
            </div>
          </div>
          <div class="col-sm-2 je_nz">
            <div class="form-group">
              <label>{% trans "Odeslat ZAA jako NZ" %}</label>
              <input class="form-control" type="text" value="{{ zaznam.akce.je_nz|true_false }}" readonly>
            </div>
          </div>
        </div>
        <div class="row formset-table">
<!--                  {% if ostatni_vedouci_objekt_formset.forms %}-->
                  {% crispy ostatni_vedouci_objekt_formset ostatni_vedouci_objekt_formset_helper %}
<!--                  {% else %}-->
<!--                  <div class="app-note">-->
<!--                    <span class="material-icons">info</span>-->
<!--                    {% trans "Akce nemá ostatní vedoucí." %}-->
<!--                  </div>-->
<!--                  {% endif %}-->
        </div>
      </div>
    </div>

    <!-- dokumentacni jednotka / mapa -->
    <div class="row mb-3">
      <div class="col-sm-4">
        <div class="card app-card-form app-card-dokumentacni-jednotka">
          <div id="karta-dokumentacni-jednotky" class="card-header">
            <div class="app-fx app-left">
              {% trans "Dokumentační jednotky" %}
            </div>
            {% if show.editovat %}
            <div class="app-fx app-right">
              <div class="btn-group" role="group">
                <button id="button-add-dj" class="btn" onclick="$('#button-add-dj').tooltip('hide');show_form('create_dj_form');document.getElementById('karta-dokumentacni-jednotky').scrollIntoView();"
                        rel="tooltip" data-placement="top"
                        title="{% trans 'Přidat dokumentační jednotku' %}">
                  <span class="material-icons">add</span>
                </button>
              </div>
            </div>
            {% endif %}
          </div>
          <div class="card-body p-0">
            <ul class="list-group list-group-flush">
              {% for j in dokumentacni_jednotky %}
                <li class="list-group-item">
                  <div class="d-flex align-items-center" id="el_div_dokumentacni_jednotka_{{ j.ident_cely_safe }}">
                    {% if j.pian.stav == 2 %} <!-- POTVRZENY JE 2 -->
                      <a href="#" class="d-flex mr-2 text-decoration-none app-pian app-confirmed" rel="tooltip"
                         data-placement="top" title="{% trans 'DJ má potvrzený pian' %}">
                        <span class="material-icons">my_location</span>
                      </a>
                    {% elif j.pian.stav == 1 %} <!-- NEPOTVRZENY JE 1 -->
                      <a href="#" class="d-flex mr-2 text-decoration-none app-pian app-notconfirmed" rel="tooltip"
                         data-placement="top" title="{% trans 'DJ má nepotvrzený pian' %}">
                        <span class="material-icons">my_location</span>
                      </a>
                    {% else %}
                      <span class="material-icons mr-2 text-decoration-none app-pian app-disabled" rel="tooltip"
                            data-placement="top" title="{% trans 'DJ nemá pian' %}">location_disabled</span>
                    {% endif %}
                    <a href="#" class="flex-fill app-entity-color" id="el_dokumentacni_jednotka_{{ j.ident_cely_safe }}">
                      <strong>{{ j.ident_cely|last_x_letters:3 }} ({{ j.typ }})</strong>
                      {% if j.adb %}- {{ j.adb.ident_cely }}{% endif %}
                    </a>
                  </div>
                  {% if j.komponenty.komponenty.all %}
                    <ul class="app-list-group-in">
                      {% for k in j.komponenty.komponenty.all %}
                        <li id="el_li_komponenta_{{ k.ident_cely_safe }}">
                          <div class="d-flex align-items-baseline">
                            <a href="#" class="flex-fill mr-2 app-entity-color"
                               id="el_komponenta_{{ k.ident_cely_safe }}">
                              {{ k.ident_cely|last_x_letters:4 }} ({{ k.obdobi }} - {{ k.areal }})
                            </a>
                            <span class="badge badge-primary badge-pill">{{ k.pocet_nalezu }}</span>
                          </div>
                        </li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                  {% empty %}
                  <div class="app-note">
                    <span class="material-icons">info</span>
                    {% trans "Akce nemá žádné dokumentační jednotky." %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      <div class="col-sm-8 pl-0">
        <style>
            #djMap {
                width: 100%;
                /* height: 473px; */
                min-height: 400px;
                height: 100%;
                border-radius: 5px;
                padding-top: 75%;
            }
        </style>
        <div id="djMap" class="app-card-shadow"></div>
      </div>
    </div>

    <!-- forms -->
    <div id="dj_forms" class="mb-3">
      <!-- dok jednotka -->
      <div class="card app-card-form" id="create_dj_form" style="display: none;">
        <div class="card-header">
          <div class="app-fx app-left">
            {% trans "Nová dokumentační jednotka" %}
          </div>
        </div>
        <div class="card-body">
          <form method="POST" action="{% url 'dj:zapsat' zaznam.ident_cely %}"
                onsubmit="newDjSubmitButton.disabled = true; return true;">
            {% crispy dj_form_create %}
            <button type="submit" id="newDjSubmitButton"
                    class="btn btn-primary">{% trans "Vytvořit jednotku" %}</button>
          </form>
        </div>
      </div>
      {% for j in dj_forms_detail %}
        <div class="card app-card-form" id="detail_dj_form_{{ j.ident_cely }}" style="display: none;">
          <div class="card-header">
            <div class="app-fx app-left">
              {% trans "Dokumentační jednotka" %} {{ j.ident_cely }}
            </div>
            <div class="app-fx app-right">
              {% if show.editovat %}
              <div class="btn-group" role="group">
                <div class="dropdown-menu" aria-labelledby="others">
                  {% if j.show_add_komponenta %}
                    <a class="dropdown-item" href="#"
                       onclick="show_create_child_form('{% url 'komponenta:zapsat' j.ident_cely %}', 'create_komponenta_form')">
                      {% trans 'Přidat komponentu' %}
                    </a>
                  {% endif %}
                  {% if j.show_add_pian %}
                    <a class="dropdown-item" href="#"
                       onclick="show_create_child_form('{% url 'pian:create' j.ident_cely %}', 'create_pian_form')">
                      {% trans 'Přidat nový pian' %}
                    </a>
                  {% endif %}
                  {% if j.show_add_pian %}
                    <a class="dropdown-item" href="#"
                       onclick="show_grap_geom_from_map('{{ j.ident_cely}}')">
                      {% trans 'Připojit pian z mapy' %}
                    </a>
                  {% endif %}
                  {% if j.show_approve_pian %}
                    <button id="pian-potvrdit-{{j.adb_ident_cely}}" class="dropdown-item pian-potvrdit-btn" type="button" name="button" href="{% url 'pian:potvrdit' j.ident_cely %}">
                      {% trans 'Potvrdit pian' %}
                    </button>
                  {% endif %}
                  {% if j.show_uprav_pian %}
                    <a class="dropdown-item" href="#"
                       onclick="show_form('detail_pian_form_{{ j.pian_ident_cely }}', 'detail_pian_form_{{ j.pian_ident_cely }}')">
                      {% trans 'Upravit pian' %}
                    </a>
                  {% endif %}
                  {% if j.show_remove_pian %}
                    <button id="pian-odpojit-{{j.adb_ident_cely}}" class="dropdown-item pian-odpojit-btn" type="button" name="button" href="{% url 'pian:odpojit' j.ident_cely %}">
                      {% trans 'Odpojit pian' %}
                    </button>
                  {% endif %}
                  {% if j.show_add_adb %}
                    <a class="dropdown-item" href="#"
                       onclick="show_create_child_form('{% url 'adb:zapsat' j.ident_cely %}', 'create_adb_form', 'detail_dj_form_{{ j.ident_cely }}')">
                      {% trans 'Přidat ADB' %}
                    </a>
                  {% endif %}
                  {% if j.show_remove_adb %}
                    <button id="adb-smazat-{{j.adb_ident_cely}}" class="dropdown-item adb-smazat-btn" type="button" name="button" href="{% url 'adb:smazat' j.adb_ident_cely %}">
                      {% trans 'Smazat ADB' %}
                    </button>
                  {% endif %}
                  <button id="dj-smazat-{{j.ident_cely}}" class="dropdown-item dj-smazat-btn" type="button" name="button" href="{% url 'dj:smazat' j.ident_cely %}">
                    {% trans 'Smazat DJ' %}
                  </button>
                  {% if j.show_pripojit_pian %}
                    <button id="pian-pripoj-{{j.pian_ident_cely}}" class="dropdown-item adb-smazat-btn" type="button" name="button" onclick=update_pian("{{j.ident_cely}}")>
                      {% trans 'Připojit PIAN podle ID' %}
                    </button>
                  {% endif %}
                </div>
                <button class="btn" type="button" id="others" type="button" data-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false" rel="tooltip" data-placement="top" title="{% trans 'Další nabídka' %}">
                  <span class="material-icons">more_vert</span>
                </button>
              </div>
              {% endif %}
            </div>
          </div>
          <div class="card-body">
            {% if not j.adb_form %}
              <form class="mb-3" method="POST" action="{% url 'dj:detail' j.ident_cely %}" onsubmit="editDjSubmitButton.disabled = true; return true;">
                {% crispy j.form %}
                {% if show.editovat %}
                <button type="submit" id="editDjSubmitButton"
                        class="btn btn-primary">{% trans "Uložit změny" %}</button>
                {% endif %}
              </form>
            {% endif %}

            {% if j.adb_form %}
            <form class="mb-3" method="POST" action="{% url 'dj:detail' j.ident_cely %}" onsubmit="editDjSubmitButton.disabled = true; return true;">
              {% crispy j.form %}
              <div class="card app-card-form app-card-inner">
                <div class="card-header">
                  <div class="app-fx app-left">
                    {% trans "Archeologický dokumentační bod" %} {{ j.adb_ident_cely }}
                  </div>
                </div>
                <div class="card-body formset-table">
                    <input type="hidden" name="adb_detail" value="{{ j.adb_ident_cely }}" />
                    {% crispy j.adb_form %}
                    <h5>{% trans "Výškové body" %}</h5>
                    <input type="hidden" name="adb_zapsat_vyskove_body" value="{{ j.adb_ident_cely }}" />
                    {% crispy j.vyskovy_bod_formset j.vyskovy_bod_formset_helper %}
                </div>
              </div>
              {% if show.editovat %}
              <button type="submit" id="editDjSubmitButton"
                      class="btn btn-primary">{% trans "Uložit změny" %}</button>
              {% endif %}
            {% endif %}
          </div>
        </div>
      {% endfor %}

      <!-- kopmonenta -->
      <div class="card app-card-form" id="create_komponenta_form" style="display: none;">
        <div class="card-header">
          <div class="app-fx app-left">
            {% trans "Nová komponenta" %}
          </div>
        </div>
        <div class="card-body">
          <form method="POST" action="#" id="create_komponenta_form_id" onsubmit="createCompotSubmitButton.disabled = true; return true;">
            <!-- Action is filled using javascript -->
            {% crispy komponenta_form_create %}
            <button type="submit" id="createCompotSubmitButton"
                    class="btn btn-primary">{% trans "Vytvořit komponentu" %}</button>
          </form>
        </div>
      </div>

      <div class="card app-card-form" id="create_adb_form" style="display: none;">
        <div class="card-header">
          <div class="app-fx app-left">
            {% trans "Nový archeologický dokumentační bod" %}
          </div>
        </div>
        <div class="card-body">
          <form method="POST" action="#" id="create_adb_form_id" onsubmit="createAdbSubmitButton.disabled = true; return true;">
            <!-- Action is filled using javascript -->
            {% crispy adb_form_create %}
            <button type="submit" id="createAdbSubmitButton"
                    class="btn btn-primary">{% trans "Vytvořit ADB" %}</button>
          </form>
        </div>
      </div>

      <div class="card app-card-form" id="create_pian_form" style="display: none;">
        <div class="card-header">
          <div class="app-fx app-left">
            {% trans "Nový pian" %}
          </div>
        </div>
        <div class="card-body">
          <form method="POST" action="#" id="create_pian_form_id" onsubmit="createPianSubmitButton.disabled = true; return true;">
            <!-- Action is filled using javascript -->
            {% crispy pian_form_create %}
            <button type="submit" id="createPianSubmitButton"
                    class="btn btn-primary">{% trans "Vytvořit pian" %}</button>
          </form>
        </div>
      </div>

      <!-- dev -->
      {% for k in komponenta_forms_detail %}
        <div class="card app-card-form" id="detail_komponenta_form_{{ k.ident_cely }}" style="display: none;">
          <div class="card-header">
            <div class="app-fx app-left">
              {% trans "Komponenta" %} {{ k.ident_cely }}
            </div>
            {% if show.editovat %}
            <div class="app-fx app-right">
              <div class="btn-group" role="group">
                <div class="dropdown-menu" aria-labelledby="others">
                  <button id="komponenta-smazat-{{k.ident_cely}}" class="dropdown-item komponenta-smazat-btn" type="button" name="button" href="{% url 'komponenta:smazat' k.ident_cely %}">
                    {% trans 'Smazat komponentu' %}
                  </button>
                </div>
                <button class="btn" type="button" id="others" type="button" data-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false" rel="tooltip" data-placement="top" title="{% trans 'Další nabídka' %}">
                  <span class="material-icons">more_vert</span>
                </button>
              </div>
            </div>
            {% endif %}
          </div>
          <div class="card-body">
            <form class="mb-3" method="POST" action="{% url 'komponenta:detail' k.ident_cely %}" onsubmit="editKompSubmitButton.disabled = true; return true;">
              {% crispy k.form %}

            <div class="card app-card-form app-card-inner">
              <div class="card-header">
                <div class="app-fx app-left">
                  {% trans "Nálezy" %}
                </div>
              </div>
              <div class="card-body formset-table">
                <h5>{% trans "Objekty" %}</h5>
                  {% if k.form_nalezy_objekty.forms %}
                    <input type="hidden" name="nalez_edit_nalez" value="{{ k.ident_cely }}" />
                    {% crispy k.form_nalezy_objekty k.helper_objekt %}
                  {% else %}
                  <div class="app-note">
                    <span class="material-icons">info</span>
                    {% trans "Komponenta neobsahuje žádné objekty." %}
                  </div>
                  {% endif %}
                <h5>{% trans "Předměty" %}</h5>
                  {% if k.form_nalezy_predmety.forms %}
                  {% crispy k.form_nalezy_predmety k.helper_predmet %}
                  {% else %}
                  <div class="app-note">
                    <span class="material-icons">info</span>
                    {% trans "Komponenta neobsahuje žádné předměty." %}
                  </div>
                  {% endif %}
              </div>
            </div>
            {% if show.editovat %}
              <button type="submit" id="editKompSubmitButton"
                      class="btn btn-primary">{% trans "Uložit změnu" %}</button>
            {% endif %}
            </form>
          </div>
        </div>
      {% endfor %}
    </div>

    {% for p in pian_forms_detail %}
      <div class="card app-card-form" id="detail_pian_form_{{ p.ident_cely }}" style="display: none;">
        <div class="card-header">
          <div class="app-fx app-left">
            {% trans "Pian" %} {{ p.ident_cely }}
          </div>
        </div>
        <div class="card-body">
          <form class="mb-3" method="POST" action="{% url 'pian:detail' p.ident_cely %}" onsubmit="editPianButton.disabled = true; return true;">
            {% crispy p.form %}
            {% if show.editovat %}
            <button type="submit" id="editPianButton"
                    class="btn btn-primary">{% trans "Upravit pian" %}</button>
            {% endif %}
          </form>
        </div>
      </div>
    {% endfor %}

    <!-- dokumenty -->

      {% include "dokument/dokument_table.html" with type="arch_z"%}

  </div>
  {% if arch_projekt_link %}
  <button id="archive_projekt" hidden class="dropdown-item archive_projekt" type="button" name="button">
  </button>
  {% endif %}
{% endblock %}

{% block script %}
  <script >
    var static_url = "{% get_static_prefix %}";
  </script>
  <script src="{% static '/js/get_vychozi_hodnota_podrazeneho.js' %}"></script>
  <script src="{% static 'mapa_pins.js' %}"></script>
  <script src="{% static 'coor_precision.js' %}"></script>
  <script src="{% static 'spin/spin.min.js' %}"></script>
  <script src="{% static 'leaflet.spin.min.js' %}"></script>
  <script src="{% static 'arch_z_detail_map.js' %}"></script>
  <script>
      function get_create_pain_form_action(selected_dj_ident) {
          const url = "/pian/create/1";
          url.replace("1", selected_dj_ident);
          document.getElementById("create_pian_form_id").action = url;
      }

      let shown_form_id = "";
      let ask_only_once=true;

      const btw_add_dj = document.getElementById("button-add-dj");
      if (btw_add_dj){
        btw_add_dj.addEventListener("click", () => {
            if (el_div_currently_selected) {
                el_div_currently_selected.style.backgroundColor = null;
            }
        });
      }
      function setCookie(name, value, path) {
          var cookieString = name + '=' + value + ';path=' + path
          document.cookie = cookieString
      }

      function getCookie(name) {
          var v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
          return v ? v[2] : null;
      }

      function show_form(form_id, form_to_show_next) {
        clearUnfinishedEditGeometry()
          let form = document.getElementById(form_id);
          if (form.style.display === "none") {
              // hide the form what was shown
              if (shown_form_id !== "") {
                  document.getElementById(shown_form_id).style.display = "none"
              }
              // Show desired form
              form.style.display = "block";
              shown_form_id = form_id
              if (form_to_show_next == null) {
                  form_to_show_next = form_id;
              }
              setCookie("detail-id-shown", form_to_show_next, "/arch-z/detail/")
          }
          if (form_id.includes("detail_dj_form_")) {
              pian_id = form_id.replace("detail_dj_form_", "")
              let xhr = new XMLHttpRequest();
              xhr.open('POST', '/arch-z/akce-zjisti-katastr');
              xhr.setRequestHeader('Content-type', 'application/json');
              if (typeof global_csrftoken !== 'undefined') {
                  xhr.setRequestHeader('X-CSRFToken', global_csrftoken);
              } else {
                  console.log("neni X-CSRFToken token")
              }
              xhr.onload = function () {
                  rs = JSON.parse(this.responseText)
                  map.setView([rs.lat, rs.lng], rs.zoom)
                  if (rs.zoom == 17) {
                      drawnItems.clearLayers();
                      addPointToPoiLayerWithForce([rs.lat, rs.lng],  drawnItems,pian_id,rs.geom)
                  }
              };
              xhr.send(JSON.stringify(
                  {
                      'cadastre': document.getElementById("main_cadastre_id").value,
                      'pian': pian_id,
                  }))

          }else if (form_id.includes("detail_pian_form_")){
            map_show_edit(true, false)
            loadGeomToEdit(form_id.replace("detail_pian_form_",""))
          }
          document.getElementById("karta-dokumentacni-jednotky").scrollIntoView();
      }

      // Na rozdil od show_form je potreba priradit akci formam ktere vytvari child element komponenty
      function show_create_child_form(url, form_id, form_to_show_next) {
          clearUnfinishedEditGeometry()

          show_form(form_id, form_to_show_next);
          let forma = document.getElementById(form_id + "_id");
          forma.action = url;
          if (form_id === "create_pian_form") {
              map_show_edit(true, false)
          }
      }

      function show_grap_geom_from_map(dj){
        global_map_can_grab_geom_from_map=dj;
        map_show_edit(true)
      }

      document.addEventListener('DOMContentLoaded', function (event) {
          // Focus on detail set by the cookie and display it
          get_vychozi_hodnota_podrazeneho("#id_areal","#id_aktivity",url)
          let detail_to_show = getCookie("detail-id-shown")
          const show_form_cookie = getCookie("show-form");
          const set_active_cookie = getCookie("set-active");
          let element_of_the_detail = document.getElementById(detail_to_show);
          if (set_active_cookie) {
              const new_el = document.getElementById(set_active_cookie);
              change_active_element(new_el);
              setCookie("set-active", "", "/");
          }
          if (show_form_cookie) {
              show_form(show_form_cookie);
              setCookie("show-form", "", "/");
              get_create_pain_form_action(show_form);
          } else if (detail_to_show != null && element_of_the_detail != null) {
              show_form(detail_to_show)
              document.getElementById("karta-dokumentacni-jednotky").scrollIntoView();
          } else {
              let xhr3 = new XMLHttpRequest();
              xhr3.open('POST', '/arch-z/akce-zjisti-katastr');
              xhr3.setRequestHeader('Content-type', 'application/json');
              if (typeof global_csrftoken !== 'undefined') {
                  xhr3.setRequestHeader('X-CSRFToken', global_csrftoken);
              } else {
                  console.log("neni X-CSRFToken token")
              }
              xhr3.onload = function () {
                  rs = JSON.parse(this.responseText)
                  map.setView([rs.lat, rs.lng], rs.zoom)
              };
              xhr3.send(JSON.stringify(
                  {
                      'cadastre': document.getElementById("main_cadastre_id").value,
                      'pian': '',
                  }))
          }
      })

      const div_komponenta_click = (data) => {
          const {ident_cely, ident_cely_safe} = data;
          show_form(`detail_komponenta_form_${ident_cely}`);
          const el_li_komponenta
              = document.getElementById(`el_li_komponenta_${ident_cely_safe}`);
          change_active_element(el_li_komponenta);
          div_komponenta = document.getElementById(`detail_komponenta_form_${ident_cely}`)
          document.getElementById("karta-dokumentacni-jednotky").scrollIntoView();
          get_vychozi_hodnota_podrazeneho(`#id_${ident_cely}-areal`,`#id_${ident_cely}-aktivity`,url);
          objekty = div_komponenta.querySelector('#objekt_table').querySelector('tbody').querySelectorAll('tr');
          for (let i = 0; i < objekty.length; i++) {
            get_vychozi_hodnota_podrazeneho(`#id_${ident_cely}_o-${i}-druh`,`#id_${ident_cely}_o-${i}-specifikace`,url);
          }
          predmety = div_komponenta.querySelector('#predmet_table').querySelector('tbody').querySelectorAll('tr');
          for (let i = 0; i < predmety.length; i++) {
            get_vychozi_hodnota_podrazeneho(`#id_${ident_cely}_p-${i}-druh`,`#id_${ident_cely}_p-${i}-specifikace`,url);
          }
      }

      const div_dokumentacni_jednotka_click = (data) => {
          const {ident_cely, ident_cely_safe} = data;
          show_form(`detail_dj_form_${ident_cely}`);
          get_create_pain_form_action(ident_cely);
          const el_div_dokumentacni_jednotka
              = document.getElementById(`el_div_dokumentacni_jednotka_${ident_cely_safe}`);
          change_active_element(el_div_dokumentacni_jednotka);
          document.getElementById("karta-dokumentacni-jednotky").scrollIntoView();
      };

      const change_active_element = (new_el) => {
          if (el_div_currently_selected) {
              el_div_currently_selected.style.backgroundColor = null;
          }
          el_div_currently_selected = new_el;
          new_el.style.backgroundColor = "rgba(36, 126, 75, 0.1)";
      }
      let el_div_currently_selected = null;
      const set_dokumentacni_jednotka_events = (ident_cely, ident_cely_safe) => {
          const el_dokumentacni_jednotka
              = document.getElementById(`el_dokumentacni_jednotka_${ident_cely_safe}`);
          el_dokumentacni_jednotka.addEventListener("click", () => {
              div_dokumentacni_jednotka_click({ident_cely: ident_cely, ident_cely_safe: ident_cely_safe})
          }, false);
      };
      const url = '{% url "heslar:get-initial-value" %}' + "?nadrazene="
      const set_komponenta_events = (ident_cely, ident_cely_safe) => {
          const el_komponenta
              = document.getElementById(`el_komponenta_${ident_cely_safe}`);
          el_komponenta.addEventListener("click", () => {
              div_komponenta_click({ident_cely: ident_cely, ident_cely_safe: ident_cely_safe})
          }, false);

      };
      {% for j in dokumentacni_jednotky %}
          set_dokumentacni_jednotka_events("{{ j.ident_cely }}", "{{ j.ident_cely_safe }}")
          {% if j.komponenty.komponenty.all %}
            {% for k in j.komponenty.komponenty.all %}
                set_komponenta_events("{{ k.ident_cely }}", "{{ k.ident_cely_safe }}")
            {% endfor %}
          {% endif %}
      {% endfor %}
  </script>
  <script>
    var global_map_projekt_ident='{{zaznam.akce.projekt.ident_cely}}';
    //console.log("zaznam "+global_map_projekt_ident)
    //modal scripts
    document.addEventListener('DOMContentLoaded', function (event) {
      if ("{{arch_projekt_link}}" !== "None"){
        var options = Object.assign(defaults, {modalID: "modal-form",
        formURL: "{% url 'projekt:projekt_archivovat' zaznam.akce.projekt.ident_cely %}?sent_stav={{projekt.stav}}&from_arch=true",
        formID: "archivovat-form",
        modalFormID: "#archivovat-form",
        })
        arch_projekt = new Modal(options, "archive_projekt");
        document.getElementById("archive_projekt").click()
      };

      if (document.getElementsByClassName("adb-smazat-btn")){
        elements = document.getElementsByClassName("adb-smazat-btn")
        for (let i = 0; i < elements.length; i++){
          var options = Object.assign(defaults, {modalID: "modal-form",
          formID: "smazat-adb-form",
          modalFormID: "#smazat-adb-form",
          })
          new Modal(options, elements.item(i).id);
        }
      }
      if (document.getElementsByClassName("dj-smazat-btn")){
        elements = document.getElementsByClassName("dj-smazat-btn")
        for (let i = 0; i < elements.length; i++){
          var options = Object.assign(defaults, {modalID: "modal-form",
          formID: "smazat-dj-form",
          modalFormID: "#smazat-dj-form",
          })
          new Modal(options, elements.item(i).id);
        }
      }
      if (document.getElementsByClassName("komponenta-smazat-btn")){
        elements = document.getElementsByClassName("komponenta-smazat-btn")
        for (let i = 0; i < elements.length; i++){
          var options = Object.assign(defaults, {modalID: "modal-form",
          formID: "smazat-komponenta-form",
          modalFormID: "#smazat-komponenta-form",
          })
          new Modal(options, elements.item(i).id);
        }
      }
      if (document.getElementsByClassName("pian-odpojit-btn")){
        elements = document.getElementsByClassName("pian-odpojit-btn")
        for (let i = 0; i < elements.length; i++){
          var options = Object.assign(defaults, {modalID: "modal-form",
          formID: "odpojit-pian-form",
          modalFormID: "#odpojit-pian-form",
          })
          new Modal(options, elements.item(i).id);
        }
      }
      if (document.getElementsByClassName("pian-potvrdit-btn")){
        elements = document.getElementsByClassName("pian-potvrdit-btn")
        for (let i = 0; i < elements.length; i++){
          var options = Object.assign(defaults, {modalID: "modal-form",
          formID: "potvrdit-pian-form",
          modalFormID: "#potvrdit-pian-form",
          })
          new Modal(options, elements.item(i).id);
        }
      }
      if ("{{show.odeslat_link}}" != "False"){
      var options = Object.assign(defaults, {modalID: "modal-form",
        formURL: "{% url 'arch_z:odeslat' zaznam.ident_cely %}?sent_stav={{zaznam.stav}}",
        formID: "odeslat-akci-form",
        modalFormID: "#odeslat-akci-form",
      })
      odeslat_akci_modal = new Modal(options, "akce-odeslat");
      };
      if ("{{show.vratit_link}}" != "False"){
      var options = Object.assign(defaults, {modalID: "modal-form",
        formURL: "{% url 'arch_z:vratit' zaznam.ident_cely %}?sent_stav={{zaznam.stav}}",
        formID: "vratit-akci-form",
        modalFormID: "#vratit-akci-form",
      })
      vratit_akci_modal = new Modal(options, "akce-vratit");
      }
      if ("{{show.archivovat_link}}" != "False"){
        var options = Object.assign(defaults, {modalID: "modal-form",
          formURL: "{% url 'arch_z:archivovat' zaznam.ident_cely %}?sent_stav={{zaznam.stav}}",
          formID: "archivovat-akci-form",
          modalFormID: "#archivovat-akci-form",
        })
      archivovat_akci_modal = new Modal(options, "akce-archivovat");
      }
      var options = Object.assign(defaults, {modalID: "modal-form",
        formURL: "{% url 'arch_z:smazat' zaznam.ident_cely %}?sent_stav={{zaznam.stav}}",
        formID: "smazat-akci-form",
        modalFormID: "#smazat-akci-form",
      })
      smazat_akci_modal = new Modal(options, "akce-smazat");
      if (document.getElementsByClassName("objekt-smazat-btn")){
        elements = document.getElementsByClassName("objekt-smazat-btn")
        for (let i = 0; i < elements.length; i++){
          var options = Object.assign(defaults, {modalID: "modal-form",
          formID: "smazat-objekt-form",
          modalFormID: "#smazat-objekt-form",
          })
          new Modal(options, elements.item(i).id);
        }
      }
      if (document.getElementsByClassName("vb-smazat-btn")){
        elements = document.getElementsByClassName("vb-smazat-btn")
        for (let i = 0; i < elements.length; i++){
          var options = Object.assign(defaults, {modalID: "modal-form",
          formID: "smazat-vb-form",
          modalFormID: "#smazat-vb-form",
          })
          new Modal(options, elements.item(i).id);
        }
      }
      var options = Object.assign(defaults, {modalID: "modal-form",
      formURL: "{% url 'uzivatel:create_osoba' %}",
      formID: "create-osoba-form",
      modalFormID: "#create-osoba-form",
      modalIDD : "#modal-form",
    })
    create_autor_popisu_modal = new Modal(options, "create-autor-popisu");
    var options = Object.assign(defaults, {modalID: "modal-form",
      formURL: "{% url 'uzivatel:create_osoba' %}",
      formID: "create-osoba-form",
      modalFormID: "#create-osoba-form",
      modalIDD : "#modal-form",
    })
    create_autor_revize_modal = new Modal(options, "create-autor-revize");
  });

</script>
<script>
    var update_pian = function (dj_ident) {
      id = "#id_" + dj_ident + "-pian"
        console.log("najdene")
        $(id).prop('disabled', false);
    };
</script>
{% endblock %}
