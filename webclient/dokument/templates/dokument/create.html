{% extends "base_logged_in.html" %}
{% load i18n %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{% trans "Nový dokument" %}{% endblock %}
{% block head %}
{% endblock %}

{% block content %}
  <div class="app-entity-dokument">
    {% include "toolbar_dokument.html" with is_3d=False %}
    <form method="post" onsubmit="newDocumentSubmitBtn.disabled = true; return true;">
      <div>
        <div class="card app-card-form">
          <div class="card-header">
            <div class="app-fx app-left">
              {% trans "Nový dokument" %}
            </div>
          </div>
          <div class="card-body">
            {% crispy formDokument %}
          </div>
        </div>
        <div class="mt-3">
          <div class="form-group">
            <button type="submit" id="newDocumentSubmitBtn" class="btn btn-primary">{% trans "Uložit" %}</button>
            <button type="button" class="btn btn-secondary" onclick="goBack();">{% trans "Zpět" %}</button>
          </div>
        </div>
      </div>
    </form>
  </div>
{% endblock %}

{% block modal-form %}
  <div class="modal fade app-modal-form" tabindex="-1" role="dialog" id="modal-form-region">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
      <div class="modal-content form" id="id-modal-region">
        <div class="modal-header">
          <h5 class="modal-title">{% trans "Generovat nové potvrzení" %}</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form >
          <div class="modal-body">
            <div class="form-group col-sm-4" id="id-modal-region-div">
              {{ formDokument.region|as_crispy_field }}
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="modal">{% trans "Potvrdit" %}</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans "Zavřít" %}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block script %}

  <script>

      function disable_disallowed(selected_value) {
          let hierarchie = {{ hierarchie }};
          let allowed_values = hierarchie[selected_value]
          let material_selectpicker = document.getElementById("id_material_originalu")
          let material_options = material_selectpicker.getElementsByTagName("option");
          // Kdyz vyberu prazdnou volbu typu dokumentu, nemuzu kliknout na zadny material
          if (!allowed_values) {
              for (let item of material_options) {
                  item.hidden = true;
              }
          } else {
              for (let item of material_options) {
                  if (!allowed_values.includes(parseInt(item.value))) {
                      item.hidden = true;
                  } else {
                      item.hidden = false;
                  }
              }
          }
      }

      // Need to disable options that are not allowed if item is selected
      $("#id_typ_dokumentu").on("changed.bs.select",
          function (e, clickedIndex, newValue, oldValue) {
              disable_disallowed(this.value)
              // Everytime typ_dokumentu is changed, also reset value of the material_originalu
              $('#id_material_originalu').selectpicker('val', '');
              $('#id_material_originalu').selectpicker('refresh');
          });

      // Check it typ_dokumentu is selected. If it is, on edit all not available materials must be disabled
      $('#id_typ_dokumentu').on('loaded.bs.select',
          function (e, clickedIndex, isSelected, previousValue) {
              disable_disallowed(this.value)
              $('#id_material_originalu').selectpicker('refresh');
          });
          {% if samostatny %}
          document.addEventListener('DOMContentLoaded', function (event) {
            $("#modal-form-region").modal("show")
          });
          $('#modal-form-region').on('hidden.bs.modal', function () {
            $('#id_region').selectpicker('val', $('#id-modal-region-div #id_region').val());
            $('#id_region').selectpicker('refresh');
          })
          {% endif %}
  </script>

{% endblock %}
