{% extends "base_logged_in.html" %}
{% load i18n %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ title }} {{ dokument.ident_cely }}{% endblock %}
{% block head %}
{% endblock %}

{% block content %}
  <div class="app-entity-akce">
    {% include "toolbar_dokument.html" %}
    <form method="post" onsubmit="newDocumentSubmitBtn.disabled = true; return true;">
      <div class="card app-card-form">
        <div class="card-header">
          <div class="app-fx app-left">
            {{ header }} {{ dokument.ident_cely }}
          </div>
        </div>
        <div class="card-body">
          {% crispy formDokument %}
          {% crispy formExtraData %}
          <button type="submit" id="newDocumentSubmitBtn"
              class="btn btn-primary mt-3">{{ button }}</button>
        </div>
      </div>

    </form>
  </div>
{% endblock %}

{% block script %}

  <script>

      function disable_disallowed(selected_value) {
          let hierarchie = {{ hierarchie }};
          let allowed_values = hierarchie[selected_value]
          let material_selectpicker = document.getElementById("id_material_originalu")
          let material_options = material_selectpicker.getElementsByTagName("option");
          if (allowed_values) {
              for (let item of material_options) {
                  if (!allowed_values.includes(parseInt(item.value))) {
                      item.disabled = true;
                  } else {
                      item.disabled = false;
                  }
              }
          }
      }

      // Need to disable options that are not allowed if item is selected
      $("#id_typ_dokumentu").on("changed.bs.select",
          function (e, clickedIndex, newValue, oldValue) {
              disable_disallowed(this.value)
              // Everytime typ_dokumentu is changed, also reset value of the material_originalu
              $('#id_material_originalu').selectpicker('val', '');
              $('#id_material_originalu').selectpicker('refresh');
          });

      // Check it typ_dokumentu is selected. If it is, on edit all not available materials must be disabled
      $('#id_typ_dokumentu').on('loaded.bs.select',
          function (e, clickedIndex, isSelected, previousValue) {
              disable_disallowed(this.value)
              $('#id_material_originalu').selectpicker('refresh');
          });

  </script>

{% endblock %}
