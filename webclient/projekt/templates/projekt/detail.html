{% extends "base_logged_in.html" %}
{% load i18n %}
{% load static %}
{% load template_filters %}

{% block title %}{% trans "Detail projektu" %}{% endblock %}
{% block head %}
  <!-- Leaflet imports -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
          integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
          crossorigin="">
  </script>
  <!--Mark Cluster-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.0/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.0/dist/leaflet.markercluster-src.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.0/dist/leaflet.markercluster.js" crossorigin=""></script>
  <!--Leaflet FullScreen-->
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
  <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css'
        rel='stylesheet'/>

  <script>
  var global_csrftoken = '{{ csrf_token }}';
  </script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

  <link rel="stylesheet" type="text/css" href="{% static 'bs-stepper.min.css' %}" />
{% endblock %}

{% block content %}
  <div class="app-entity-projekt">
    {% include "toolbar_projekt.html" with projekt=projekt showcontrols=True %}

    <div class="bs-stepper">
      <div class="bs-stepper-header">
        <div class="step {% if projekt.stav == 0 %}active{% endif %}">
          <button type="button" class="btn step-trigger projekt">
            <span class="bs-stepper-circle">0</span>
            <span class="bs-stepper-label">
              {% trans "Oznámený" %}
              <span class="app-stepper-date" rel="tooltip" data-placement="bottom" title="{{ history_dates.datum_oznameni.uzivatel }}">
                {{ history_dates.datum_oznameni.datum|date:'Y/m/d'|default_if_none:"" }}
              </span>
            </span>
          </button>
        </div>
        <div class="line projekt"></div>
        <div class="step {% if projekt.stav == 1 %}active{% endif %}">
          <button type="button" class="btn step-trigger projekt">
            <span class="bs-stepper-circle">1</span>
            <span class="bs-stepper-label">
              {% trans "Zapsaný" %}
              <span class="app-stepper-date" rel="tooltip" data-placement="bottom" title="{{ history_dates.datum_zapsani.uzivatel }}">
                {{ history_dates.datum_zapsani.datum|date:'Y/m/d'|default_if_none:"" }}
              </span>
            </span>
          </button>
        </div>
        <div class="line projekt"></div>
        <div class="step {% if projekt.stav == 2 %}active{% endif %}">
          <button type="button" class="btn step-trigger projekt">
            <span class="bs-stepper-circle">2</span>
            <span class="bs-stepper-label">
              {% trans "Přihlášený" %}
              <span class="app-stepper-date" rel="tooltip" data-placement="bottom" title="{{ history_dates.datum_prihlaseni.uzivatel }}">
                {{ history_dates.datum_prihlaseni.datum|date:'Y/m/d'|default_if_none:"" }}
              </span>
            </span>
          </button>
        </div>
        <div class="line projekt"></div>
        <div class="step {% if projekt.stav == 3 %}active{% endif %}">
          <button type="button" class="btn step-trigger projekt">
            <span class="bs-stepper-circle">3</span>
            <span class="bs-stepper-label">
              {% trans "Zahájen v terénu" %}
              <span class="app-stepper-date" rel="tooltip" data-placement="bottom" title="{{ history_dates.datum_zahajeni_v_terenu.uzivatel }}">
                {{ history_dates.datum_zahajeni_v_terenu.datum|date:'Y/m/d'|default_if_none:"" }}
              </span>
            </span>
          </button>
        </div>
        <div class="line projekt"></div>
        <div class="step {% if projekt.stav == 4 %}active{% endif %}">
          <button type="button" class="btn step-trigger projekt">
            <span class="bs-stepper-circle">4</span>
            <span class="bs-stepper-label">
              {% trans "Ukončen v terénu" %}
              <span class="app-stepper-date" rel="tooltip" data-placement="bottom" title="{{ history_dates.datum_ukonceni_v_terenu.uzivatel }}">
                {{ history_dates.datum_ukonceni_v_terenu.datum|date:'Y/m/d'|default_if_none:"" }}
              </span>
            </span>
          </button>
        </div>
        <div class="line projekt"></div>
        <div class="step {% if projekt.stav == 5 %}active{% endif %}">
          <button type="button" class="btn step-trigger projekt">
            <span class="bs-stepper-circle">5</span>
            <span class="bs-stepper-label">
              {% trans "Uzavřený" %}
              <span class="app-stepper-date" rel="tooltip" data-placement="bottom" title="{{ history_dates.datum_uzavreni.uzivatel }}">
                {{ history_dates.datum_uzavreni.datum|date:'Y/m/d'|default_if_none:"" }}
              </span>
            </span>
          </button>
        </div>
        <div class="line projekt"></div>
        <div class="step {% if projekt.stav == 6 %}active{% endif %}">
          <button type="button" class="btn step-trigger projekt">
            <span class="bs-stepper-circle">6</span>
            <span class="bs-stepper-label">
              {% trans "Archivovaný" %}
              <span class="app-stepper-date" rel="tooltip" data-placement="bottom" title="{{ history_dates.datum_archivace.uzivatel }}">
                {{ history_dates.datum_archivace.datum|date:'Y/m/d'|default_if_none:"" }}
              </span>
            </span>
          </button>
        </div>
        <div class="line projekt"></div>
        <div class="step {% if projekt.stav == 7 %}active{% endif %}">
          <button type="button" class="btn step-trigger projekt">
            <span class="bs-stepper-circle">7</span>
            <span class="bs-stepper-label">
              {% trans "Navržen ke zrušení" %}
              <span class="app-stepper-date" rel="tooltip" data-placement="bottom" title="{{ history_dates.datum_navrhu_ke_zruseni.uzivatel }}">
                {{ history_dates.datum_navrhu_ke_zruseni.datum|date:'Y/m/d'|default_if_none:"" }}
              </span>
            </span>
          </button>
        </div>
        <div class="line projekt"></div>
        <div class="step {% if projekt.stav == 8 %}active{% endif %}">
          <button type="button" class="btn step-trigger projekt">
            <span class="bs-stepper-circle">8</span>
            <span class="bs-stepper-label">
              {% trans "Zrušen" %}
              <span class="app-stepper-date" rel="tooltip" data-placement="bottom" title="{{ history_dates.datum_zruseni.uzivatel }}">
                {{ history_dates.datum_zruseni.datum|date:'Y/m/d'|default_if_none:"" }}
              </span>
            </span>
          </button>
        </div>
      </div>
    </div>

    <div class="card app-card-form">
      <div class="card-header">
        <div class="app-fx app-left">
          {% trans "Detail" %}
        </div>
        {% if show.editovat %}
        <div class="app-fx app-right">
          <div class="btn-group" role="group">
            <a class="btn app-entity-projekt" href="{% url 'projekt:edit' projekt.ident_cely %}" rel="tooltip" data-placement="top" title="{% trans 'Upravit' %}">
              <span class="material-icons">edit</span>
            </a>
          </div>
        </div>
        {% endif %}
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-sm-9">
            <div class="row">
              <div class="col-sm-3">
                <div class="form-group">
                  <label for="formGroupExampleInput">{% trans "Typ projektu" %}</label>
                  <input class="form-control" type="text" value="{{ projekt.typ_projektu }}" readonly>
                </div>
              </div>
              <div class="col-sm-3">
                <div class="form-group">
                  <label for="formGroupExampleInput">{% trans "Hlavní katastr" %}</label>
                  <input class="form-control" type="text" value="{{ projekt.hlavni_katastr }}" readonly>
                </div>
              </div>
              <div class="col-sm-6">
                <div class="form-group">
                  <label>{% trans "Další katastry" %}</label>
                  <div class="input-group">
                    <input class="form-control app-ellipsis" stype="text" value="{{ dalsi_katastry|katastry_to_list }}" readonly>
                    <div class="input-group-append" data-toggle="popover" data-placement="top"
                    data-content="<strong>{% trans 'Seznam katastrů' %}:</strong> {{ dalsi_katastry|katastry_to_list }}">
                      <span class="input-group-text">
                        <span class="material-icons">info</span>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-sm-12">
                <div class="form-group">
                  <label for="formGroupExampleInput">{% trans "Podnět" %}</label>
                  <textarea class="form-control" value="{{ projekt.podnet }}" rows="2" readonly></textarea>
                </div>
              </div>
              <div class="col-sm-12">
                <div class="form-group">
                  <label for="formGroupExampleInput">{% trans "Lokalizace" %}</label>
                  <textarea class="form-control" value="{{ projekt.lokalizace }}" rows="1" readonly></textarea>
                </div>
              </div>
              <div class="col-sm-12">
                <div class="form-group">
                  <label for="formGroupExampleInput">{% trans "Parcelní číslo" %}</label>
                  <input class="form-control" type="text" value="{{ projekt.parcelni_cislo }}" readonly>
                </div>
              </div>
              <div class="col-sm-6">
                <div class="form-group">
                  <label for="formGroupExampleInput">{% trans "Označení stavby" %}</label>
                  <input class="form-control" type="text" value="{{ projekt.oznaceni_stavby }}" readonly>
                </div>
              </div>
              <div class="col-sm-3">
                <div class="form-group">
                  <label for="formGroupExampleInput">{% trans "Plánované zahájení prací" %}</label>
                  <input class="form-control" type="text" value="{{ projekt.planovane_zahajeni|render_daterange }}" readonly>
                </div>
              </div>
            </div>
          </div>
          <div class="col-sm-3">
            <div id="projectMap"></div>

            <script src="{% static 'mapa.js' %}"></script>
            <script>
                global_map_can_edit=false;
                button_map_lock.disable();
                let coordinates='{{ projekt.geom.coords }}'.slice(1, -1).split(',');
                console.log(coordinates)
                if(coordinates && coordinates.length>1) {
                    addPointOnLoad(coordinates[1], coordinates[0], "Uživatelem zadaná poloha záměru");
                }
            </script>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-12">
            <span class="app-divider-label">{% trans "Přihlášení projektu" %}</span>
            <hr class="mt-0" />
          </div>
          <div class="col-sm-4">
            <div class="form-group">
              <label for="formGroupExampleInput">{% trans "Vedoucí projektu" %}</label>
              <input class="form-control" type="text" value="{{ projekt.vedouci_projektu}}" readonly>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="form-group">
              <label for="formGroupExampleInput">{% trans "Organizace" %}</label>
              <input class="form-control" type="text" value="{{ projekt.organizace}}" readonly>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="form-group">
              <label for="formGroupExampleInput">{% trans "Uživatelské označení" %}</label>
              <input class="form-control" type="text" value="{{ projekt.uzivatelske_oznaceni }}" readonly>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label for="formGroupExampleInput">{% trans "Památková ochrana" %}</label>
              <input class="form-control" type="text" value="{{ projekt.kulturni_pamatka }}" readonly>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label for="formGroupExampleInput">{% trans "Rejstříkové číslo USKP" %}</label>
              <input class="form-control" type="text" value="{{ projekt.kulturni_pamatka_cislo }}" readonly>
            </div>
          </div>
          <div class="col-sm-6">
            <div class="form-group">
              <label for="formGroupExampleInput">{% trans "Název památky" %}</label>
              <input class="form-control" type="text" value="{{ projekt.kulturni_pamatka_popis }}" readonly>
            </div>
          </div>
          <div class="col-sm-12">
            <span class="app-divider-label">{% trans "Terenní část" %}</span>
            <hr class="mt-0" />
          </div>
          <div class="col-sm-4">
            <div class="form-group">
              <label for="formGroupExampleInput">{% trans "Datum zahájení výzkumu" %}</label>
              <input class="form-control" type="text" value="{{ projekt.datum_zahajeni|date:'Y-m-d' }}" readonly>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="form-group">
              <label for="formGroupExampleInput">{% trans "Datum ukončení výzkumu" %}</label>
              <input class="form-control" type="text" value="{{ projekt.datum_ukonceni|date:'Y-m-d' }}" readonly>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="form-group">
              <label for="formGroupExampleInput">{% trans "Termín odevzdání" %}</label>
              <input class="form-control" type="text" value="{{ projekt.termin_odevzdani_nz|date:'Y-m-d' }}" readonly><!--missings-->
            </div>
          </div>
        </div>
      </div>
    </div>
    {% if show.oznamovatel %}
      <div class="card app-card-form">
        <div class="card-header">
          <div class="app-fx app-left">
            {% trans "Oznamovatel" %}
          </div>
          <div class="app-fx app-right">
            <div class="btn-group" role="group">
              <a class="btn app-entity-projekt" href="{% url 'oznameni:oznameni_edit' projekt.oznamovatel.id %}" rel="tooltip" data-placement="top" title="{% trans 'Upravit' %}">
                <span class="material-icons">edit</span>
              </a>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-sm-6">
              <div class="form-group">
                <label for="formGroupExampleInput">{% trans "Oznamovatel" %}</label>
                <input class="form-control" type="text" value="{{ oznamovatel.oznamovatel }}" readonly>
              </div>
            </div>
            <div class="col-sm-6">
              <div class="form-group">
                <label for="formGroupExampleInput">{% trans "Pověřená osoba oznamovatele" %}</label>
                <input class="form-control" type="text" value="{{ oznamovatel.odpovedna_osoba }}" readonly>
              </div>
            </div>
            <div class="col-sm-6">
              <div class="form-group">
                <label for="formGroupExampleInput">{% trans "Adresa oznamovatele" %}</label>
                <input class="form-control" type="text" value="{{ oznamovatel.adresa }}" readonly>
              </div>
            </div>
            <div class="col-sm-3">
              <div class="form-group">
                <label for="formGroupExampleInput">{% trans "Telefon" %}</label>
                <input class="form-control" type="text" value="{{ oznamovatel.telefon }}" readonly>
              </div>
            </div>
            <div class="col-sm-3">
              <div class="form-group">
                <label for="formGroupExampleInput">{% trans "Email" %}</label>
                <input class="form-control" type="text" value="{{ oznamovatel.email }}" readonly>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="card app-card-form">
      <div class="card-header">
        <div class="app-fx app-left">
          {% trans "Projektová dokumentace" %}
        </div>
        <div class="app-fx app-right">
          <div class="btn-group" role="group">
            <a class="btn app-entity-projekt" href="{% url 'core:upload_file_projekt' projekt.ident_cely %}" rel="tooltip" data-placement="top" title="{% trans 'Nahrát dokumentaci' %}">
              <span class="material-icons">publish</span>
            </a>
          </div>
        </div>
      </div>
      <div class="card-body">
        {% if soubory %}
          {% include "core/filetable.html" with soubory=soubory next_url='/projekt/detail/' ident=projekt.ident_cely %}
        {% else %}
          <div class="app-note">
            <span class="material-icons">info</span>
            {% trans "Projekt zatím neobsahuje žádnou projektovou dokumentaci." %}
          </div>
        {% endif %}
      </div>
    </div>

    <div class="card app-card-form app-card-akce">
      <div class="card-header">
        <div class="app-fx app-left">
          {% trans "Archeologické akce" %}
        </div>
        <div class="app-fx app-right">
          <div class="btn-group" role="group">
            {% if show.pridat_akci %}
            <a class="btn app-entity-projekt" href="{% url 'arch_z:zapsat' projekt.ident_cely %}" rel="tooltip" data-placement="top" title="{% trans 'Vložit další akci' %}">
              <span class="material-icons">add</span>
            </a>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="card-body">
        {% if akce %}
        <table class="table table-striped table-hover table-sm mb-0">
          <thead>
            <tr>
              <th>{% trans "Ident cely" %}</th>
              <th>{% trans "Přístupnost" %}</th>
              <th>{% trans "Katastry" %}</th>
              <th>{% trans "Vedoucí" %}</th>
              <th>{% trans "Datum" %}</th>
              <th>{% trans "Typ" %}</th>
              <th>{% trans "Uživatelské označení" %}</th>
              <th>{% trans "Stav" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for a in akce %}
              <tr>
                <td class="app-ident-cely">
                  <a href="{% url 'arch_z:detail' a.archeologicky_zaznam.ident_cely %}">
                    <span class="material-icons">brush</span>
                    {{ a.archeologicky_zaznam.ident_cely }}
                  </a>
                </td>
                <td>{{ a.archeologicky_zaznam.pristupnost }}</td>
                <td>
                  <strong>{{ a.archeologicky_zaznam.hlavni_katastr }}</strong>
                  {% if a.archeologicky_zaznam.katastry.all %}, {{ a.archeologicky_zaznam.katastry.all|katastry_to_list }}{% endif %}
                </td>
                <td>{{ a.hlavni_vedouci }}</td>
                <td>{{ a.datum_zahajeni|date:'Y/m/d' }} - {{ a.datum_ukonceni|date:'Y/m/d' }}</td>
                <td>{{ a.hlavni_typ }}, {{ a.vedlejsi_typ }}</td>
                <td>{{ a.archeologicky_zaznam.uzivatelske_oznaceni }}</td>
                <td><div class="badge">{{ a.archeologicky_zaznam.get_stav_display }}</div></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
          <div class="app-note">
            <span class="material-icons">info</span>
            {% trans "Projekt zatím neobsahuje žádné projektové akce." %}
          </div>
        {% endif %}
      </div>
    </div>

    {% if show.samostatne_nalezy %}
    <div class="card app-card-form app-card-samostatny_nalez">
      <div class="card-header">
        <div class="app-fx app-left">
          {% trans "Samostatné nálezy" %}
        </div>
        <div class="app-fx app-right">
          <div class="btn-group" role="group">
            <a class="btn app-entity-projekt" href="" rel="tooltip" data-placement="top" title="{% trans 'Vložit další nález' %}">
              <span class="material-icons">add</span>
            </a>
          </div>
        </div>
      </div>
      <div class="card-body">
        {% if samostatne_nalezy %}
        <table class="table table-striped table-hover table-sm mb-0">
          <thead>
            <tr>
              <th>{% trans "Ident cely" %}</th>
              <th>{% trans "Katastr" %}</th>
              <th>{% trans "Lokalizace" %}</th>
              <th>{% trans "Období" %}</th>
              <th>{% trans "Nález" %}</th>
              <th>{% trans "Materiál" %}</th>
              <th>{% trans "Nálezce" %}</th>
              <th>{% trans "Datum nálezu" %}</th>
              <th>{% trans "Stav" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for nalez in samostatne_nalezy %}
              <tr>
                <td class="app-ident-cely">
                  <a href="{% url 'pas:detail' nalez.ident_cely %}">
                    <span class="material-icons">brush</span>
                    {{ nalez.ident_cely }}
                  </a>
                </td>
                <td>{{ nalez.katastr }}</td>
                <td>{{ nalez.lokalizace }}</td>
                <td>{{ nalez.obdobi }}</td>
                <td>{{ nalez.druh_nalezu }}</td>
                <td>{{ nalez.specifikace }}</td>
                <td>{{ nalez.nalezce }}</td>
                <td>{{ nalez.datum_nalezu|date:'Y/m/d' }}</td>
                <td><div class="badge">{{ nalez.get_stav_display }}</div></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="app-note">
          <span class="material-icons">info</span>
          {% trans "Projekt zatím neobsahuje žádné samostatné nálezy." %}
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

  </div>
{% endblock %}

{% block script %}

{% endblock %}
