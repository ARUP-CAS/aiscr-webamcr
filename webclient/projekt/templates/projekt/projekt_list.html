{% extends "base_logged_in.html" %}
{% load i18n %}
{% load static %}
{% load crispy_forms_tags %}
{% load render_table from django_tables2 %}
{% load export_url from django_tables2 %}

{% block title %}{% trans "Seznam projektu" %}{% endblock %}
{% block head %}{% endblock %}

{% block content %}
  <div class="app-entity-projekt">
    {% include "toolbar_projekt.html" with projekt=projekt %}

    {% if filter %}
      <form method="get">
        <div class="mb-3 d-flex flex-row align-items-center justify-content-between">
          <div class="app-left">
            <button class="btn btn-primary collapsed mr-1" type="button" data-toggle="collapse" data-target="#filter" aria-expanded="false" aria-controls="collapseExample">
              <span class="material-icons mr-1">filter_alt</span>{% trans "Filtr" %}<span class="material-icons app-icon-expand">expand_more</span>
            </button>
            <a href="{% url 'projekt:list' %}" class="btn btn-danger" id="id-cancel-filter-link" style="display: none">
              <span class="material-icons">clear</span> {% trans "Smazat filtr" %}
            </a>
          </div>
          <div class="app-middle text-muted">
            {% trans "Počet nalezených projektů: " %}<strong>{{ table.rows|length }}</strong>
          </div>
          <div class="app-right">
            <div class="btn-group" role="group">
              <!-- <button type="button" class="btn btn-primary">
                <span class="material-icons app-icon-expand">expand_more</span>
              </button> -->
              <div class="btn-group" role="group">
                <button id="btnGroupDropTable" type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" rel="tooltip" data-placement="top" title="{% trans 'Zobrazení slouců' %}">
                  <span class="material-icons">table_chart</span>
                </button>
                <div class="dropdown-menu" aria-labelledby="btnGroupDropTable">
                  {% for column in table.columns %}
                    {% if column.attrs.td.class in table.get_column_default_show %}
                      <a class="btn-shift-column dropdown-item"
                          data-td-class="{{ column.attrs.td.class }}"
                          data-state="on"
                          {% if not forloop.last %} style="border-bottom:1px solid #ccc;" {% endif %}
                          data-table-class-container="{{ table.uniq_table_class_name }}">
                        <img
                            src="{% static "django_tables2_column_shifter/img/check.png" %}"
                            alt="loader"
                            style="width:20px; height:20px; margin-right:5px; opacity:0.7;"
                            class="ico check"
                        />
                        <img
                            src="{% static "django_tables2_column_shifter/img/uncheck.png" %}"
                            alt="loader"
                            style="width:20px; height:20px; margin-right:5px; display: none; opacity:0.7;"
                            class="ico uncheck"
                        />
                        {{ column.header }}
                      </a>
                    {% else %}
                      <a class="btn-shift-column dropdown-item"
                          data-td-class="{{ column.attrs.td.class }}"
                          data-state="off"
                          {% if not forloop.last %} style="border-bottom:1px solid #ccc;" {% endif %}
                          data-table-class-container="{{ table.uniq_table_class_name }}">
                        <img
                            src="{% static "django_tables2_column_shifter/img/check.png" %}"
                            alt="loader"
                            style="width:20px; height:20px; margin-right:5px; display:none; opacity:0.7;"
                            class="ico check"
                        />
                        <img
                            src="{% static "django_tables2_column_shifter/img/uncheck.png" %}"
                            alt="loader"
                            style="width:20px; height:20px; margin-right:5px; opacity:0.7;"
                            class="ico uncheck"
                        />
                        {{ column.header }}
                      </a>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>        
              <div class="btn-group" role="group">
                <button id="btnGroupDropDownload" type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" rel="tooltip" data-placement="top" title="{% trans 'Stáhnout soubor' %}">
                  <span class="material-icons">download</span>
                </button>
                <div class="dropdown-menu" aria-labelledby="btnGroupDropDownload">
                  {% for format in export_formats %}
                    <a href="{% export_url format %}" class="dropdown-item">
                      {% trans "Stáhnout" %} <code>.{{ format }}</code>
                    </a>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="collapse mb-3" id="filter">
          <div class="card app-card-form">
            <div class="card-body">
              {% crispy filter.form filter.helper %}
              <button type="submit" class="btn btn-primary">
                <span class="material-icons">check</span> {% trans "Vybrat projekty" %}
              </button>
            </div>
          </div>
        </div>
      </form>
    {% endif %}
    <div class="app-table-list-wrapper">
      {% render_table table 'projekt/bootstrap4.html' %}
    </div>
  </div>
{% endblock %}

{% block script %}
  <script>
      $(document).ready(function () {

          const STAV_OZNAMENY = '0'
          const STAV_ZAPSANY = '1'
          const STAV_PRIHLASENY = '2'
          const STAV_ZAHAJEN = '3'
          const STAV_UKONCEN = '4'
          const STAV_UZAVREN = '5'

          setPageHeader();

          function setHeader(header) {
              document.getElementById('id-app-entity-item').innerHTML = header;
          }

          function listMatch(required, actual) {
              if (actual.length === required.length && actual.every(function (value, index) {
                  return value === required[index]
              })) {
                  return true;
              } else {
                  return false;
              }
          }

          function hasOnlySchvalitOznameni(actualParams, actualValues) {
              if (listMatch(['stav'], actualParams) && listMatch([STAV_OZNAMENY], actualValues)) {
                  setHeader("Schválit oznámení")
                  return true
              } else {
                  return false
              }
          }

          function hasOnlyPrihlasitProjekt(actualParams, actualValues) {
              if (listMatch(['stav'], actualParams) && listMatch([STAV_ZAPSANY], actualValues)) {
                  setHeader("Přihlásit projekt")
                  return true
              } else {
                  return false
              }
          }

          function hasOnlyZahajitVyzkum(actualParams, actualValues) {
              if (listMatch(['stav', 'organizace'], actualParams) && listMatch([STAV_PRIHLASENY], actualValues)) {
                  setHeader("Zahájit výzkum")
                  return true
              } else {
                  return false
              }
          }

          function hasOnlyUkoncitTeren(actualParams, actualValues) {
              if (listMatch(['stav', 'organizace'], actualParams) && listMatch([STAV_ZAHAJEN], actualValues)) {
                  setHeader("Ukončit terén")
                  return true
              } else {
                  return false
              }
          }

          function hasOnlySpravovatAkce(actualParams, actualValues) {
              if (listMatch(['stav', 'stav', 'organizace'], actualParams) && listMatch([STAV_ZAHAJEN, STAV_UKONCEN], actualValues)) {
                  setHeader("Spravovat akce")
                  return true
              } else {
                  return false
              }
          }

          function hasOnlyUzavritProjekt(actualParams, actualValues) {
              if (listMatch(['stav', 'organizace'], actualParams) && listMatch([STAV_UKONCEN], actualValues)) {
                  setHeader("Uzavřít projekt")
                  return true
              } else {
                  return false
              }
          }

          function hasOnlyVybratProjekty(actualParams, actualValues) {
              if (listMatch([], actualParams) && listMatch([], actualValues)) {
                  setHeader("Vybrat projekty")
                  return true
              } else {
                  return false
              }
          }

          function hasOnlyNaseProjekty(actualParams, actualValues) {
              if (listMatch(['organizace'], actualParams) && listMatch(['{{ user.organizace.id }}'], actualValues)) {
                  setHeader("Naše projekty")
                  return true
              } else {
                  return false
              }
          }

          function hasOnlyArchivovatProjekty(actualParams, actualValues) {
              if (listMatch(['stav', 'organizace'], actualParams) && listMatch([STAV_UZAVREN], actualValues)) {
                  setHeader("Ukončit terén")
                  return true
              } else {
                  return false
              }
          }

          function setPageHeader() {
              const queryString = window.location.search;
              const urlParams = new URLSearchParams(queryString);
              const keys = Array.from(urlParams.keys());
              const values = Array.from(urlParams.values());
              if (!(hasOnlySchvalitOznameni(keys, values) ||
                  hasOnlyPrihlasitProjekt(keys, values) ||
                  hasOnlyZahajitVyzkum(keys, [urlParams.get('stav')]) ||
                  hasOnlyUkoncitTeren(keys, [urlParams.get('stav')]) ||
                  hasOnlySpravovatAkce(keys, urlParams.getAll('stav')) ||
                  hasOnlyUzavritProjekt(keys, [urlParams.get('stav')]) ||
                  hasOnlyVybratProjekty(keys, values) ||
                  hasOnlyNaseProjekty(keys, values) ||
                  hasOnlyArchivovatProjekty(keys, [urlParams.get('stav')])
              )) {
                  setHeader("Vybrané projekty")
                  document.getElementById('id-cancel-filter-link').style.display = "inline-block";
              }
          }
      });
  </script>
  <script
      type="text/javascript"
      src="{% static "django_tables2_column_shifter/js/django_tables2_column_shifter.min.js" %}">
  </script>
{% endblock %}
